<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clicker Pescados</title>
  <style>
    body {
      font-family: Arial;
      color: #111;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px;
    }
    .card {
      background: #f7f7f7;
      padding: 20px;
      border-radius: 10px;
      max-width: 420px;
      width: 100%;
      text-align: center;
    }
    button {
      padding: 10px 18px;
      border-radius: 8px;
      border: none;
      background: #06b6d4;
      color: white;
      cursor: pointer;
    }
    input {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 100%;
      margin: 6px 0;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div class="card">
    <h2>Clicker de Pescados</h2>

    <div id="auth">
      <button id="btn-discord">Iniciar sesión con Discord</button>
      <hr/>
      <p>O, si ya estás logueado, configura tu Discord ID (opcional).</p>
    </div>

    <div id="user-area" style="display:none">
      <p>Usuario ID: <span id="user-id"></span></p>
      <p>Discord Tag: <span id="discord-tag"></span></p>
      <p>Discord ID (numérico): <input id="discord-id" placeholder="123456789012345678" /></p>
      <button id="save-discord">Guardar Discord ID</button>
      <hr/>
      <p>Pescados: <strong id="fish-count">0</strong></p>
      <button id="clicker">¡Pezcar! +1</button>
    </div>

    <p id="msg" style="color:green"></p>
  </div>

<script>
  window.onload = async () => {
    const SUPABASE_URL = 'https://gbfuaqibhrdhbkmabveo.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdiZnVhcWliaHJkaGJrbWFidmVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NzY3NjYsImV4cCI6MjA3MDQ1Mjc2Nn0.y0gAd5xySKJrCOKGpEjXM4vgcd9LwPvRe1PPcpFl_tE';

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const btnDiscord = document.getElementById('btn-discord');
    const userArea = document.getElementById('user-area');
    const userIdSpan = document.getElementById('user-id');
    const discordTagSpan = document.getElementById('discord-tag');
    const fishCountSpan = document.getElementById('fish-count');
    const clickerBtn = document.getElementById('clicker');
    const msg = document.getElementById('msg');
    const discordInput = document.getElementById('discord-id');
    const saveDiscordBtn = document.getElementById('save-discord');
    const authDiv = document.getElementById('auth');

    // Limpia el hash (#access_token=...) de la URL después de que Supabase procese el token
    function clearUrlHash() {
      if (window.history && window.history.replaceState) {
        window.history.replaceState(null, null, window.location.pathname + window.location.search);
      } else {
        // Fallback para navegadores antiguos
        window.location.hash = '';
      }
    }

    // Chequear sesión e inicializar UI
    async function checkSession() {
      const { data, error } = await client.auth.getSession();

      if (data.session) {
        const user = data.session.user;
        authDiv.style.display = 'none';
        userArea.style.display = 'block';
        userIdSpan.textContent = user.id;

        let discordTag = '';
        if (user.user_metadata && user.user_metadata.provider_id === 'discord') {
          discordTag = user.user_metadata.name || user.user_metadata.user_name || '';
        }
        discordTagSpan.textContent = discordTag || '(No disponible)';

        // Obtener datos del jugador desde Supabase
        const { data: players, error } = await client
          .from('players')
          .select('*')
          .eq('user_id', user.id)
          .maybeSingle();

        if (error) {
          console.error(error);
          msg.textContent = 'Error cargando datos: ' + error.message;
          fishCountSpan.textContent = '0';
          discordInput.value = '';
          return;
        }

        if (players) {
          fishCountSpan.textContent = players.fish || 0;
          discordInput.value = players.discord_id || '';
        } else {
          fishCountSpan.textContent = '0';
          discordInput.value = '';
        }
      } else {
        authDiv.style.display = 'block';
        userArea.style.display = 'none';
        userIdSpan.textContent = '';
        discordTagSpan.textContent = '';
        fishCountSpan.textContent = '0';
        discordInput.value = '';
      }
    }

    // Primero verifica si hay token en URL y que supabase procese la sesión
    try {
      const { error } = await client.auth.getSession();
      // Si el token está en la URL, Supabase automáticamente lo toma al llamar getSession
      // Limpiamos el hash para que no quede visible
      clearUrlHash();
    } catch (e) {
      console.error('Error procesando sesión:', e);
    }

    checkSession();

    client.auth.onAuthStateChange((_event, session) => {
      checkSession();
    });

    btnDiscord.addEventListener('click', async () => {
      const { error } = await client.auth.signInWithOAuth({
        provider: 'discord',
      });
      if (error) {
        msg.textContent = 'Error: ' + error.message;
        console.error(error);
      }
    });

    clickerBtn.onclick = async () => {
      const { data, error } = await client.auth.getSession();
      if (!data.session) {
        msg.textContent = 'Debes iniciar sesión primero.';
        return;
      }
      const user = data.session.user;
      const { data: newFish, error: rpcError } = await client.rpc('increment_fish', {
        p_user: user.id,
        p_amount: 1,
      });
      if (rpcError) {
        console.error(rpcError);
        msg.textContent = 'Error: ' + rpcError.message;
        return;
      }
      fishCountSpan.textContent = String(newFish);
    };

    saveDiscordBtn.onclick = async () => {
      const discordId = discordInput.value.trim();
      const { data, error } = await client.auth.getSession();
      if (!data.session) {
        msg.textContent = 'Debes iniciar sesión primero.';
        return;
      }
      const user = data.session.user;
      const { error: upsertError } = await client
        .from('players')
        .upsert({ user_id: user.id, discord_id: discordId }, { merge: true });
      if (upsertError) {
        msg.textContent = 'Error guardando: ' + upsertError.message;
        return;
      }
      msg.textContent = 'Discord ID guardado (puede requerir verificación manual).';
    };
  };
</script>
</body>
</html>
